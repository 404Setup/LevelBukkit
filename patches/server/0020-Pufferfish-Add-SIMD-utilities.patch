From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: 404Setup <153366651+404Setup@users.noreply.github.com>
Date: Fri, 31 May 2024 11:24:45 +0800
Subject: [PATCH] Pufferfish: Add SIMD utilities


diff --git a/build.gradle.kts b/build.gradle.kts
index 11735d5a662741182666e9135afc2662bb841d43..47883134d112ef111e013624beb541cab19357b0 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -64,6 +64,14 @@ dependencies {
 }
 
 val craftbukkitPackageVersion = "1_20_R3" // Paper
+
+// Pufferfish Start
+tasks.withType<JavaCompile> {
+    val compilerArgs = options.compilerArgs
+    compilerArgs.add("--add-modules=jdk.incubator.vector")
+}
+// Pufferfish End
+
 tasks.jar {
     archiveClassifier.set("dev")
 
diff --git a/src/main/java/dev/paged/lb/Config/LevelBukkitConfig.java b/src/main/java/dev/paged/lb/Config/LevelBukkitConfig.java
index 9870278a4e34c876219e784702e7d1b5e1b5519d..4d92b5040c166047d0253a61bb330640fbfcb6c7 100644
--- a/src/main/java/dev/paged/lb/Config/LevelBukkitConfig.java
+++ b/src/main/java/dev/paged/lb/Config/LevelBukkitConfig.java
@@ -1,11 +1,16 @@
 package dev.paged.lb.Config;
 
+import org.bukkit.Bukkit;
 import org.bukkit.configuration.file.YamlConfiguration;
+import gg.pufferfish.pufferfish.simd.SIMDDetection;
 
 import java.io.File;
 import java.io.IOException;
+import java.util.logging.Logger;
 
 public class LevelBukkitConfig {
+    public static Logger logger = Logger.getLogger("LevelBukkit");
+
     public static class foldenor {
         public static boolean enableSecureSeed = false;
     }
@@ -22,6 +27,27 @@ public class LevelBukkitConfig {
             configuration.save(configFile);
 
             foldenor.enableSecureSeed = configuration.getBoolean("foldenor.enableSecureSeed");
+
+            // Pufferfish start
+            // Attempt to detect vectorization
+            try {
+                SIMDDetection.isEnabled = SIMDDetection.canEnable(logger);
+                SIMDDetection.versionLimited = SIMDDetection.getJavaVersion() != 17 && SIMDDetection.getJavaVersion() != 18 && SIMDDetection.getJavaVersion() != 19;
+            } catch (NoClassDefFoundError | Exception ignored) {
+                ignored.printStackTrace();
+            }
+
+            if (SIMDDetection.isEnabled) {
+                logger.info("SIMD operations detected as functional. Will replace some operations with faster versions.");
+            } else if (SIMDDetection.versionLimited) {
+                logger.warning("Will not enable SIMD! These optimizations are only safely supported on Java 17, Java 18, and Java 19.");
+            } else {
+                logger.warning("SIMD operations are available for your server, but are not configured!");
+                logger.warning("To enable additional optimizations, add \"--add-modules=jdk.incubator.vector\" to your startup flags, BEFORE the \"-jar\".");
+                logger.warning("If you have already added this flag, then SIMD operations are not supported on your JVM or CPU.");
+                logger.warning("Debug: Java: " + System.getProperty("java.version") + ", test run: " + SIMDDetection.testRun);
+            }
+
         } catch (IOException e) {
             throw new RuntimeException(e);
         }
